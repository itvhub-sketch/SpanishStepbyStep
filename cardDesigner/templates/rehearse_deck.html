{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
    <div class="row">
        {% for card in list_of_cards %}
        <div class="rehearse_card" id="card-{{ card.id }}">
            <div class="card text-center" style="width: 30rem;">
                <img src="{% static 'images/FlashCardImage.svg' %}" class="card-img-top" alt="...">
                <div class="card-body">
                    <div class="card-front">
                        <h4 class="card-title-question">Q: {{ card.question }}</h4>
                        <button class="btn btn-primary btn-sm" onclick="flipCard('{{ card.id }}')">Flip Card</button>
                        <button class="btn btn-secondary btn-sm tts-button" data-card-id="{{ card.id }}"
                            data-question-audio="{{ card.question_audio.url }}">Text to Speech (Question)</button>
                    </div>
                    <div class="card-back" style="display: none;">
                        <h5 class="card-text-answer">A: {{ card.answer }}</h5>
                        <button class="btn btn-secondary btn-sm tts-button" data-card-id="{{ card.id }}"
                            data-answer-audio="{{ card.answer_audio.url }}">Text to Speech (Answer)</button>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">{{ card.id }} {{ card.deck.title }} Â· {{ card.deck.subject }}</small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    </div>
    </div>
</div>

<script>
    function flipCard(cardId) {
        const cardFront = document.querySelector(`#card-${cardId} .card-front`);
        const cardBack = document.querySelector(`#card-${cardId} .card-back`);

        if (cardFront && cardBack) {
            cardFront.style.display = cardFront.style.display === 'none' ? 'block' : 'none';
            cardBack.style.display = cardBack.style.display === 'none' ? 'block' : 'none';
        } else {
            console.error('Card elements not found.');
        }
    }

    function toggleTextToSpeech(button) {
        const cardId = button.dataset.cardId;
        const deckId = window.location.pathname.split('/')[3]; // Assuming the deck_id is the 4th part of the URL path
        const questionAudioUrl = button.dataset.questionAudio;
        const answerAudioUrl = button.dataset.answerAudio;

        const url = `/deck/rehearse/${deckId}/text_to_speech/${cardId}/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            const questionAudio = new Audio(`data:audio/mpeg;base64,${data.question_audio}`);
            const answerAudio = new Audio(`data:audio/mpeg;base64,${data.answer_audio}`);

            questionAudio.play();
            questionAudio.addEventListener('ended', () => {
                answerAudio.play();
            });
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    const ttsButtons = document.querySelectorAll('.tts-button');
    ttsButtons.forEach(button => {
        button.addEventListener('click', () => toggleTextToSpeech(button));
    });
</script>
{% endblock %}
